name : Build

on:
  push:
    branches:
        - master
  pull_request:
    branches:
      - master

jobs:
  check_clang_format:
    name: "Check C++ style"
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3
    - name: Run clang-format style check for C/C++/Protobuf programs.
      uses: jidicula/clang-format-action@v4.11.0
      with:
        clang-format-version: '16'
        check-path: '.'
        #exclude-regex: 'sse2neon.h'

  editorconfig:
    name: "Check editorconfig"
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v2
      - uses: editorconfig-checker/action-editorconfig-checker@main
      - run: editorconfig-checker

  ubuntu:
    strategy:
      fail-fast: false
      matrix:
        cxx: [20]
        build_type: ["RelWithDebInfo"]
        compiler:
          [
            "g++-11",
            "clang++-15"
          ]
    name: "Ubuntu 22.04 (${{ matrix.compiler }}, C++${{ matrix.cxx }}, ${{matrix.build_type}})"
    runs-on: ubuntu-22.04
    outputs:
      id: "${{ matrix.compiler }} (C++${{ matrix.cxx }}, ${{ matrix.build_type }})"
    steps:
      - uses: actions/checkout@v3
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: "ccache-ubuntu2204-${{ matrix.compiler }}-${{ matrix.cxx }}-${{ matrix.build_type }}"
          max-size: 256M
      - name: "update APT database"
        run: sudo apt -q update

      - name: Set up Clang
        uses: egor-tensin/setup-clang@v1
        with:
          version: 15

      - name: "Download dependencies"
        run: sudo apt install cmake ninja-build # catch2
      # workaround for broken clang on ubuntu runner until https://github.com/actions/runner-images/issues/8659 get fixed
      #- uses: mjp41/workaround8649@7929373c0fe5caf844d8115adccef39e3b5362e7
      - name: Install Compilers
        run: sudo apt install -y g++-12
      - name: "Cmake configure"
        run: |
          cmake -S . -B build -G Ninja \
              -DBOXED_CPP_TESTS=OFF \
              -DENABLE_TIDY=ON \
              -DPEDANTIC_COMPILER=ON \
              -DCMAKE_CXX_FLAGS="-Wno-unknown-warning-option" \
              -DCMAKE_CXX_COMPILER=${{ matrix.compiler }} \
              -DCMAKE_CXX_STANDARD=${{ matrix.cxx }} \
              -DCMAKE_BUILD_TYPE=${{matrix.build_type}}
      - name: "build"
        run: cmake --build build  --parallel 3

      - name: "run test"
        if: ${{ false }} # disabled, because of Github runner image bug in compiler-vs-stdlib
        run: ./build/test-boxed-cpp
